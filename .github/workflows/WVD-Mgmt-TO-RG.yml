name: AVD Management deployment
on:
  workflow_dispatch:
    inputs:
      enableDeploymentMasterARMTemplate:
        description: 'Deploy Master Template'
        type: boolean
        required: false 
      enablePostDeploymentWVDKeyVault:
        description: 'Invoke Key Vault Post Deployment'
        type: boolean
        required: true 
      old_rgname: 
        description: 'Delete Previous Resource Group Name (Cleanup)'
        required: false
        type: string
      rgname:
        description: 'Target Resource Group Name'
        required: true
        default: 'myAvdWorkFlowCall'
        type: string
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'sbx' 
        type: choice
        options:
        - sbx
        - test
        - prod 

# env:
  # orchestrationPath: ${{ github.workspace }}/Workloads/WVD/Environments/template-orchestrated
  # orchestrationFunctionsPath: ${{ github.workspace }}/Workloads/WVD/OrchestrationSources/SharedDeploymentFunctions
  # wvdUploadsPath: ${{ github.workspace }}/Workloads/WVD/OrchestrationSources/Uploads

jobs:

  Clean_Resources:
    name: Clean up Resources
    runs-on: ubuntu-latest
    if: github.event.inputs.old_rgname
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set Environment Variables
        uses: ./.github/actions/setvars
        with:
          source: ./.github/variables/WVD-Mgmt-TO-RG.env
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS_Y3QJT}}
      - name: Remove Resources
        id: task-remove-resources
        uses: azure/CLI@v1
        with:
          azcliversion: 2.30.0
          inlineScript: |
            az group delete --name ${{github.event.inputs.old_rgname}} --yes
  
  ## Deploy Management resource Group Resources
  Deploy_Mgmt:
    name: Deploy Management Resources
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.enableDeploymentMasterARMTemplate == 'true' }}
    needs: Clean_Resources
    # strategy:
    #   matrix: ${{ fromJson(needs.parser.outputs.matrix) }}
    #   fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      # - name: Install PowerShell modules
      #   shell: pwsh
      #   run: |
      #     Install-Module -Name "Az" -RequiredVersion "4.7.0" -Force -Scope CurrentUser -ErrorAction Stop
      - name: Set Environment Variables
        uses: ./.github/actions/setvars
        with:
          source: ./.github/variables/WVD-Mgmt-TO-RG.env
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS_Y3QJT}}
      - name: Check Params
        run: |
          echo "Deployment Name: ${{ env.resourcegroupname }}-$(date +'%Y%m%d%H%M%S')"
          echo "Template Name: ${{ env.orchestrationPath }}/${{ env.rgFolder }}/deploy.json"
          echo "Parameters: ${{ env.orchestrationPath }}/${{ env.rgFolder }}/Parameters/parameters.json componentStorageAccountId=${{secrets.AZURE_CREDENTIALS_Y3QJT}} componentsStorageContainerName=${{env.componentsStorageContainerName}}"
          echo "Pipeline Params: ${{ github.event.inputs.rgname }}"
          echo "Start VM on Connect Service Principals: ${{ env.soc_service_principals }}"
      
      - name: Get Windows Virtual Desktop Service Principal ClientId
        id: task-get-sp-clientd-id
        uses: azure/CLI@v1
        with:
          azcliversion: 2.30.0
          inlineScript: |
            query_filter=
            for client_id in ${{ env.soc_service_principals }}; do 
                query_filter="${query_filter}displayname eq '${client_id}' or "
            done
            # remove trailing or
            query_filter=${query_filter:0:$#-4}
            sp_client_id=$(az ad sp list --all --filter "$query_filter" --query "[].objectId" -o tsv)
            echo ::set-output name=sp_client_id::$sp_client_id
      - name: Show Service Principal
        id: task-show-sp
        run: echo client_id ${{ steps.task-get-sp-clientd-id.outputs.sp_client_id }}
      
      - name: Validate Module
        id: task-validate
        uses: azure/arm-deploy@v1
        with:
          deploymentMode: Validate
          deploymentName: github-test
          scope: subscription
          region: ${{ env.LOCATION }}
          template: ${{ env.orchestrationPath }}/${{ env.rgFolder }}/deploy.json
          parameters: ${{ env.orchestrationPath }}/${{ env.rgFolder }}/Parameters/parameters.json resourcegroupname=${{ github.event.inputs.rgname }} componentStorageAccountId=${{secrets.COMPONENT_STORAGE_ACCOUNT_ID_Y3QJT}} componentsStorageContainerName=${{env.componentsStorageContainerName}} soCWvdPrincipalIds="${{steps.task-get-sp-clientd-id.outputs.sp_client_id}}"
      
      - name: Deploy Module
        id: task-deploy
        uses: azure/arm-deploy@v1
        with:
          deploymentName: github-test
          scope: subscription
          region: ${{ env.LOCATION }}
          template: ${{ env.orchestrationPath }}/${{ env.rgFolder }}/deploy.json
          parameters: ${{ env.orchestrationPath }}/${{ env.rgFolder }}/Parameters/parameters.json resourcegroupname=${{ github.event.inputs.rgname }} componentStorageAccountId=${{secrets.COMPONENT_STORAGE_ACCOUNT_ID_Y3QJT}} componentsStorageContainerName=${{env.componentsStorageContainerName}} soCWvdPrincipalIds="${{steps.task-get-sp-clientd-id.outputs.sp_client_id}}"
      
      - name: Check Template Output Params
        run: |
          echo Template Output - socClientIds: ${{ steps.task-deploy.ouputs.socClientIds }}
          echo Template Output - sasExpiryDateTime: ${{ steps.task-deploy.outputs.sasExpiryDateTime }}
          echo Template Output - deploymentName: ${{ steps.task-deploy.ouputs.deploymentName }}
          echo Template Output - keyVaultResourceId: ${{ steps.task-deploy.ouputs.keyVaultResourceId }}

      - name: Log out of Azure
        uses: azure/CLI@v1
        with:
          azcliversion: 2.30.0
          inlineScript: |
            az logout
            az cache purge
            az account clear

# Invoke Key Vault Post Deployment
  Invoke_WVDKeyVaultPostDeployment:
    name: Invoke Key Vault Post Deployment
    # needs: Deploy_Mgmt
    if: ${{ github.event.inputs.enablePostDeploymentWVDKeyVault == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set Environment Variables
        uses: ./.github/actions/setvars
        with:
          varFilePath: ./.github/variables/WVD-Mgmt-TO-RG.env
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS_Y3QJT}}
          enable-AzPSSession: true
      - name: Get KeyVault Name
        id: task-get-keyvault-name
        uses: azure/powershell@v1
        with:
          inlineScript: |
            Get-AzContext
            Get-AzSubscription
            # $KeyVault = Get-AzKeyVault -ResourceGroupName "${{ github.event.inputs.rgname }}"
            Write-Output ::set-output name=keyvault_name::"kvz7usdpdycchtc"
          azPSVersion: "latest"
      - name: Trigger module KeyVault post-deployment
        uses: azure/powershell@v1
        with:
          inlineScript: |
            Write-Verbose "Load function" -Verbose
            . '${{ env.orchestrationFunctionsPath }}/GeneralDeployment/Invoke-KeyVaultPostDeployment.ps1'

            $functionInput = @{
              orchestrationFunctionsPath   = '${{ env.orchestrationFunctionsPath }}'
              VaultName                    = '${{ steps.task-get-keyvault-name.ouputs.key_vault_name }}'
              domainJoin_userName          = '${{ env.domainJoinUserName }}'
              domainJoin_pwd               = ConvertTo-SecureString '${{ secrets.WVD_JOIN_DOMAIN_USER_PWD }}' -AsPlainText -Force
            }

            if(-not ([string]::IsNullOrEmpty('${{ secrets.LOCAL_ADMIN_PASSWORD }}'))) {
              $functionInput += @{
                localAdminPassword         = ConvertTo-SecureString '${{ secrets.LOCAL_ADMIN_PASSWORD }}' -AsPlainText -Force
              }
            }

            # # Only required to enable Native AD identity-based access for file shares
            # if(-not ([string]::IsNullOrEmpty('$(storageJoinUserName)'))) {
            #   $functionInput += @{
            #     storageJoin_userName       = '$(storageJoinUserName)'
            #     storageJoin_pwd            = ConvertTo-SecureString "$(StorageJoinUserPwd)" -AsPlainText -Force
            #   }
            # }

            Write-Verbose "Invoke task with" -Verbose
            $functionInput.Keys | ForEach-Object { Write-Verbose ("PARAMETER: `t'{0}' with value '{1}'" -f $_, $functionInput[$_]) -Verbose }

            Invoke-KeyVaultPostDeployment @functionInput -Verbose
          azPSVersion: "latest"

# ## Invoke Automation Account Post Deployment
#   Invoke_AutomationAccountPostDeployment:
#     name: Invoke Automation Account Post Deployment
#     needs: Deploy_Mgmt
#     runs-on: windows-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v2
#       - name: Set Environment Variables
#         uses: ./.github/actions/setvars
#         with:
#           varFilePath: ./.github/variables/WVD-Mgmt-TO-RG.env
#       - name: Login to Azure
#         uses: azure/login@v1
#         with:
#           creds: ${{secrets.AZURE_CREDENTIALS}}
#           enable-AzPSSession: true
#       - name: Trigger module AutomationAccount post-deployment
#         uses: azure/powershell@v1
#         with:
#           inlineScript: |
#             Write-Verbose "Load function" -Verbose
#             . '${{ env.orchestrationFunctionsPath }}/GeneralDeployment/Invoke-AutomationAccountPostDeployment.ps1'

#             $functionInput = @{
#               orchestrationFunctionsPath         = '${{ env.orchestrationFunctionsPath }}'
#               AutomationAccountName              = '${{ env.AutomationAccountName }}'
#               AutomationAccountRGName            = '${{ env.resourcegroupname }}'
#               ScalingRunbookName                 = '${{ env.ScalingRunbookName }}'
#               WebhookName                        = '${{ env.ScalingWebhookName }}'
#               RunAsConnectionSPName              = '${{ env.RunAsConnectionSPName }}'
#               KeyVaultName                       = '${{ env.keyVaultName }}'
#               RunAsSelfSignedCertSecretName      = '${{ env.RunAsSelfSignedCertSecretName }}'
#               AutoAccountRunAsCertExpiryInMonths = '${{ env.AutoAccountRunAsCertExpiryInMonths }}'
#               tempPath                           = '${{ runner.temp }}'
#               # LAWorkspaceName                    = '${{ env.LAWorkspaceName }}'
#             }

#             Write-Verbose "Invoke task with" -Verbose
#             $functionInput.Keys | ForEach-Object { Write-Verbose ("PARAMETER: `t'{0}' with value '{1}'" -f $_, $functionInput[$_]) -Verbose }

#             Invoke-AutomationAccountPostDeployment @functionInput -Verbose
#           azPSVersion: "latest"